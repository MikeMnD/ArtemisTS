define(["require","exports","core/utils/Bag","core/utils/Hashmap"],function(n,t,i,r){var f=i,e=r,o=function(){function n(n){this._className="EntitySystem",this._actives=new f.Bag,this.aspect=n,this._allSet=n.getAllSet(),this._exclusionSet=n.getExclusionSet(),this._oneSet=n.getOneSet(),this._systemIndex=u.getIndexFor(this),this._dummy=this._allSet.isEmpty()&&this._oneSet.isEmpty()}return n.prototype.getClassName=function(){return this._className},n.prototype.begin=function(){},n.prototype.process=function(){this.checkProcessing()&&(this.begin(),this.processEntities(this._actives),this.end())},n.prototype.end=function(){},n.prototype.processEntities=function(){throw new Error("This method is abstract");},n.prototype.checkProcessing=function(){throw new Error("This method is abstract");},n.prototype.initialize=function(){},n.prototype.inserted=function(){},n.prototype.removed=function(){},n.prototype.check=function(n){var i;if(!this._dummy){var u=n.getSystemBits().get(this._systemIndex)!=0?!0:!1,t=!0,r=n.getComponentBits();if(!this._allSet.isEmpty())for(i=this._allSet.nextSetBit(0);i>=0;i=this._allSet.nextSetBit(i+1))if(!r.get(i)){t=!1;break}!this._exclusionSet.isEmpty()&&t&&(t=!this._exclusionSet.intersects(r)),this._oneSet.isEmpty()||(t=this._oneSet.intersects(r)),t&&!u?this.insertToSystem(n):!t&&u&&this.removeFromSystem(n)}},n.prototype.removeFromSystem=function(n){this._actives.remove(n),n.getSystemBits().clear(this._systemIndex),this.removed(n)},n.prototype.insertToSystem=function(n){this._actives.add(n),n.getSystemBits().set(this._systemIndex),this.inserted(n)},n.prototype.added=function(n){this.check(n)},n.prototype.changed=function(n){this.check(n)},n.prototype.deleted=function(n){n.getSystemBits().get(this._systemIndex)&&this.removeFromSystem(n)},n.prototype.disabled=function(n){n.getSystemBits().get(this._systemIndex)&&this.removeFromSystem(n)},n.prototype.enabled=function(n){this.check(n)},n.prototype.setWorld=function(n){this.world=n},n.prototype.isPassive=function(){return this._passive},n.prototype.setPassive=function(n){this._passive=n},n.prototype.getActives=function(){return this._actives},n}(),u;t.EntitySystem=o,u=function(){function n(){this._INDEX=0,this._indices=new e.Hashmap}return n.getIndexFor=function(n){var t=this._indices.get(n);return t==null&&(t=this._INDEX++,this._indices.put(n,t)),t},n}()})